<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style type="text/css">
            html, body {
                padding: 0;
                margin: 0;
                width:100%;
                height:100vh;
                overflow: hidden;
                min-width: 960px;
            }

            p{
                padding: 0;
                margin: 0;
            }

            header{
                padding: 0;
                margin: 0;
                height: 10vh;
                width: 100%;
                background-color: black;
                color:white;
            }
            footer{
                padding: 0;
                margin: 0;
                height: 10vh;
                width: 100%;
                background-color: black;
                color:white;
            }
            #main{
                padding: 0;
                margin: 0;
                height: 80vh;
                width: 100%;
                display: flex;

            }
            #preview{
                background: black;
                width: 50%;
                min-width: 480px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #edit{
                background: rgb(75, 64, 224);
                width: 50%;
                min-width: 480px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #preview canvas,img{
                width: 100%;
            }
          
            
    </style>
    <script src="../js/canvas2svg.js"></script>
    <!--<script src="https://cdn.bootcss.com/sketch.js/1.1/sketch.min.js"></script>
    <script src="https://cdn.bootcss.com/opentype.js/0.8.0/opentype.min.js"></script>-->
    
    <script src="https://cdn.bootcss.com/gif.js/0.2.0/gif.js"></script>
   
</head>
<body>
    <header>
        <nav>xxx</nav>

    </header>
    <div id="main">
        <div id="preview"></div>
        <div id="edit"></div>
    </div>
    <footer>
        <p>xxx</p>

    </footer>
    <script>
        //https://github.com/jnordberg/gif.js

    
    Array.prototype.sum = function (){
        return this.reduce(function (partial, value){
        return partial + value;
        })
    };


    function DYText(opts){

        var _opts=opts||{};

        this.word=_opts.word||"Hello World";
        
        this.height=_opts.height||120;
        this.fontSize=this.height+'px';
        this.fontFamily=_opts.fontFamily||'zcool-gdh';

        this.font="italic small-caps 900 "+this.fontSize+" "+this.fontFamily;

        this.offset=(this.height*_opts.offset)||this.height*0.015;
        this.x=_opts.x||0;
        this.y=_opts.y||0;

        this.divideNum=_opts.divideNum||6;
        this.seed=_opts.seed||0.51;

        this.offsetLeft=true;


        this.colorLeft=_opts.colorLeft||"yellow";
        this.colorRight=_opts.colorRight||"red";
        this.color=_opts.color||"black";
        this.colorBg=_opts.colorBg||'black';

        this.fullscreen=true;

        this.dev=!!_opts.dev;

        this.gifLength=_opts.gifLength||10;

    };

    DYText.prototype.random=function(min,max){
        var num=Math.random()*(max-min)+min;
        return num
    };

    DYText.prototype.sin=function(len){
        console.log(len);
        var res=[];
        for(var i=0;i<len;i++){
            var num=parseFloat(Math.abs(Math.sin(this.random(0,6))).toString().slice(0,4))*100;
            res.push(num);
        };
        
        var sum=res.sum();

        for(var i=0;i<res.length;i++){
            res[i]=res[i]/sum;
           // console.log(res[i],"ijujujuj")
        };

     
        return res;
    };


    DYText.prototype.generate=function(){

        var res=[];

        var x=this.x,
            y=this.y,
            width=this.width,
            height=this.height,
            seed=this.seed;
            
            //console.log(height,'!!')
        



        var i=this.divideNum;

        var height_seeds=this.sin(i);

       // console.log(x,y,width,height,height_seeds)

        for (let index = 0; index < i; index++) {

            this.offsetLeft=!this.offsetLeft;

           // console.log(height*height_seeds[index],'!!!')
            
            var _yn=(index==0?0:(res[index-1].get.height+res[index-1].get.y)),
                _h=height*height_seeds[index];

            if (_h<=2) {
                _h=2;
            };

            var get={
                x:x,
                y:_yn,
                width:width,
                height:_h
            },
            put={
                x:x+index*(this.offsetLeft?-1:1)*seed,
                y:_yn
            },
            obj={
                get:get,
                put:put
            };

            res.push(obj);
            
        
        };

        this.divides=res;
    };

    DYText.prototype.update=function(seed){

        this.seed=seed||this.seed;

        if (this.ctx) {
            this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);
            this.draw();
            this.drawBg();
            this.generate();
            this.copy();
        }else{
            this.start();
        };
           

    };

    DYText.prototype.init=function(){
        var canvas=document.createElement('canvas');
        

        var ctx=canvas.getContext('2d');
        this.ctx=ctx;

        ctx.textBaseline="top";
        ctx.font=this.font;

        var word=this.word,
            offset=this.offset;    

        this.width=ctx.measureText(word).width+this.offset*2;
        
        canvas.width=this.width+100;
        this.x=50;
        canvas.height =this.height;

      //  this.ctx.fillStyle=this.colorBg;
       // this.ctx.fillRect(0,0,canvas.width,canvas.height);
    };

    DYText.prototype.drawBg=function(){
        var canvasBg=document.createElement('canvas'),
            ctxBg=canvasBg.getContext('2d');
        
        canvasBg.width=this.ctx.canvas.width;
        canvasBg.height=this.ctx.canvas.height;


        ctxBg.fillStyle=this.colorBg;
        ctxBg.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);

        var word=this.word,
            offset=this.offset,
            x=this.x,
            y=this.y;

        var ctx=this.ctx;

        ctxBg.textBaseline="top";
        ctxBg.font=this.font;
        
        ctxBg.fillStyle=this.color;
        ctxBg.fillText(word,x+offset,y+offset);
       
        ctxBg.drawImage(ctx.canvas,0,0);

        ctx.drawImage(canvasBg,0,0);
    };

    DYText.prototype.draw=function(){
        var word=this.word,
            offset=this.offset,
            x=this.x,
            y=this.y;

        var ctx=this.ctx;

        ctx.textBaseline="top";
        ctx.font=this.font;

        ctx.fillStyle=this.colorLeft;
        ctx.fillText(word,x-offset,y-offset);
        
       // ctx.fillStyle=this.color;
        //ctx.fillText(word,x,y);
        
        ctx.globalCompositeOperation="xor";
        ctx.fillStyle=this.colorRight;
        ctx.fillText(word,x+offset,y+offset);
        
       /* ctx.globalCompositeOperation="xor";
        ctx.fillStyle=this.color;
        ctx.fillText(word,x,y);
        */
        ctx.globalCompositeOperation="source-over";

    };

    DYText.prototype.copy=function(){

        var divides=this.divides;
        var ctx=this.ctx;   
        
       // console.log(divides)

        ctx.globalCompositeOperation="source-over";
        
        for (let index = 0; index < divides.length; index++) {
            var d=divides[index];
         
            var imgData=ctx.getImageData(d.get.x,d.get.y,d.get.width,d.get.height);

            ctx.putImageData(imgData,d.put.x,d.put.y);
            
            if (this.dev) {
                
                ctx.strokeStyle="red";
                ctx.strokeRect(d.get.x,d.get.y,d.get.width,d.get.height);
            }
        };


      

    };


    DYText.prototype.toCanvas=function(targetCtx){
       
        var ctx=this.ctx;
        targetCtx.canvas.width=ctx.canvas.width;
        targetCtx.canvas.height=ctx.canvas.height;

        targetCtx.drawImage(ctx.canvas,0,0);
    };

    DYText.prototype.start=function(){
        this.init();
        this.draw();
        this.drawBg();
        this.generate();
        this.copy();
    };

    DYText.prototype.createFrames=function(num){
        var frames=[],num=num||this.gifLength;

        for (let index = 0; index < num; index++) {
            this.update();

            var canvas1=document.createElement('canvas'),
                ctx1=canvas1.getContext('2d');
            
                canvas1.width=window.innerWidth;
                canvas1.height=window.innerHeight;
                
            this.toCanvas(ctx1);

            frames.push(canvas1);
            
        };

        this.frames=frames;

        return frames;
    };

    DYText.prototype.createGif=function(cb){
        
        var gif = new GIF({
                workers: 8,
                quality: 10,
                workerScript:'./gif.worker.js'
            });
            
            
            var frames=this.createFrames();

            for (let index = 0; index < frames.length; index++) {
                        
                    gif.addFrame(frames[index], {delay:200})
                    
            };


            gif.on('finished', function(blob) {
               
                cb(URL.createObjectURL(blob));
                
            });

            gif.render();
    };



    var dytext=new DYText({
        word:'抖音风格的字体',
        color:'white',
        colorBg:'#1F0D1C',
        colorLeft:'#00F5EB',
        colorRight:'#FF0050',
        dev:false,
        seed:0.7,
        divideNum:10
    });
    
    var previewElement=document.querySelector('#preview');

    function createImg(){
        var canvasTarget=document.createElement('canvas'),
        ctxTarget=canvasTarget.getContext('2d');
        canvasTarget.width=window.innerWidth;

        dytext.start();
        dytext.toCanvas(ctxTarget);
        previewElement.innerHTML='';
        previewElement.appendChild(canvasTarget);
    };

    function createGif(){
        dytext.createGif(function(gif){

        var img=document.createElement('img');
            img.src=gif;
            previewElement.innerHTML='';
            previewElement.appendChild(img);
        })
    };

 
 

        
    </script>
</body>
</html>